---
title: "Introduction to RFM"
author: "Aravind Hebbali"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to RFM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

```{r, echo=FALSE, message=FALSE}
library(segmentr)
library(knitr)
library(kableExtra)
library(magrittr)
library(dplyr)
library(ggplot2)
library(DT)
library(grDevices)
library(RColorBrewer)
options(knitr.table.format = "html") 
options(tibble.width = Inf)
```

**RFM** (recency, frequency, monetary) analysis is a behavior based technique used to segment customers by examining their transaction history  such as

- how recently a customer has purchased (recency)
- how often they purchase (frequency)
- how much the customer spends (monetary)

It is based on the marketing axiom that **80% of your business comes from 20% of your customers**. RFM helps to identify customers who are more likely to respond to promotions by segmenting them into various categories.

## Data

To calculate the RFM score for each customer we need transaction data for
each customer which should include the following

- a unique customer id 
- date of transaction/order
- transaction/order amount

`segmentr` includes a sample data set `rfm_data` which includes the above details:

```{r rfm_data}
rfm_data
```

## RFM Score

- customers are assigned a recency score based on date of most recent purchase or time interval since most recent purchase. This score is based on a simple ranking of recency values into a small number of categories. For example, if you use five categories, the customers with the most recent purchase dates receive a recency ranking of 5, and those with purchase dates furthest in the past receive a recency ranking of 1.

- in a similar fashion, customers are then assigned a frequency ranking, with higher values representing a higher frequency of purchases. For example, in a five category ranking scheme, customers who purchase most often receive a frequency ranking of 5.

- finally, customers are ranked by monetary value, with the highest monetary values receiving the highest ranking. Continuing the five-category example, customers who have spent the most would receive a monetary ranking of 5.

The result is four scores for each customer: recency, frequency, monetary, and combined RFM score, which is simply the three individual scores concatenated into a single value. The “best” customers (those most likely to respond to an offer) are those with the highest combined RFM scores. For example, in a five-category ranking, there is a total of 125 possible combined RFM scores, and the highest combined RFM score is 555.

Use `rfm_table()` to generate the scores for each customer.

```{r rfm_table, eval=FALSE}
analysis_date <- lubridate::as_date('2006-12-31', tz = 'UTC')
rfm_result <- rfm_table(rfm_data, customer_id, order_date, revenue, analysis_date)
rfm_result 
```

```{r rfm_table2, eval=TRUE, echo=FALSE}
analysis_date <- lubridate::as_date('2006-12-31', tz = 'UTC')
rfm_result <- rfm_table(rfm_data, customer_id, order_date, revenue, analysis_date)
rfm_result %>%
  use_series(rfm) %>%
  slice(1:10) %>%
  kable() %>%
  kable_styling()
```

### Heat Map

The heat map of mean monetary distribution shows the average monetary value for categories defined by recency and frequency scores. Darker areas indicate a higher average monetary value.

```{r heatmap, fig.align='center', fig.width=8, fig.height=6}
rfm_heatmap(rfm_result)
```

### Bar Chart

The chart of bin counts displays the bin distribution for the selected binning method. Each bar represents the number of cases that will be assigned each combined RFM score.

- Although you typically want a fairly even distribution, with all (or most) bars of roughly the same height, a certain amount of variance should be expected when using the default binning method that assigns tied values to the same bin.

- Extreme fluctuations in bin distribution and/or many empty bins may indicate that you should try another binning method (fewer bins and/or random assignment of ties) or reconsider the suitability of RFM analysis.

```{r barchart, fig.align='center', fig.width=8, fig.height=6}
rfm_bar_chart(rfm_result)
```

## Histogram

The histograms show the relative distribution of values for the three variables used to calculate recency, frequency, and monetary scores. It is not unusual for these histograms to indicate somewhat skewed distributions rather than a normal or symmetrical distribution.

The horizontal axis of each histogram is always ordered from low values on the left to high values on the right. With recency, however, the interpretation of the chart depends on the type of recency measure: date or time interval. For dates, the bars on the left represent values further in the past (a less recent date has a lower value than a more recent date). For time intervals, the bars on the left represent more recent values (the smaller the time interval, the more recent the transaction).

```{r rfmhist, fig.align='center', fig.width=8, fig.height=6}
rfm_histograms(rfm_result)
```

## Customers by Orders

Visualize the distribution of customers across orders.

```{r rfmorders, fig.align='center', fig.width=8, fig.height=6}
rfm_order_dist(rfm_result)
```

### Scatter Plots

These scatterplots show the relationships between the three variables used to calculate recency, frequency, and monetary scores.

It’s common to see noticeable linear groupings of points on the frequency scale, since frequency often represents a relatively small range of discrete values. For example, if the total number of transactions doesn’t exceed 15, then there are only 15 possible frequency values (unless you
count fractional transactions), whereas there could by hundreds of possible recency values and thousands of monetary values.

The interpretation of the recency axis depends on the type of recency measure: date or time interval. For dates, points closer to the origin represent dates further in the past. For time intervals, points closer to the origin represent more recent values.

#### Recency vs Monetary Value

```{r mr, fig.align='center', fig.width=7, fig.height=7}
rfm_rm_plot(rfm_result)
```

#### Frequency vs Monetary Value

```{r fm, fig.align='center', fig.width=7, fig.height=7}
rfm_fm_plot(rfm_result)
```

#### Recency vs Frequency 

```{r fr, fig.align='center', fig.width=7, fig.height=7}
rfm_rf_plot(rfm_result)
```

## Segments

```{r segments, echo=FALSE}
segment <- c('Champions', 'Loyal Customers', 'Potential Loyalist',
             'New Customers', 'Promising', 'Need Attention',
             'About To Sleep', 'At Risk', "Can't Lose Them", 'Hibernating',
             'Lost')
description <- c("Bought recently, buy often and spend the most",
                 "Spend good money. Responsive to promotions",
                 "Recent customers, spent good amount, bought more than once", 
                 "Bought more recently, but not often",
                 "Recent shoppers, but haven't spent much",
                 "Above average recency, frequency & monetary values",
                 "Below average recency, frequency & monetary values",
                 "Spent big money, purchased often but long time ago",
                 "Made big purchases and often, but long time ago",
                 "Low spenders, low frequency, purchased long time ago",
                 "Lowest recency, frequency & monetary scores")
recency <- c('4 - 5', '2 - 5', '3 - 5', '4 - 5', '3 - 4', '2 - 3', '2 - 3', '<= 2', '<= 1', '1 - 2', '<= 2')
frequency <- c('4 - 5', '3 - 5', '1 - 3', '<= 1', '<= 1', '2 - 3', '<= 2', '2 - 5', '4 - 5', '1 - 2', '<= 2')
monetary <- c('4 - 5', '3 - 5', '1 - 3', '<= 1', '<= 1', '2 - 3', '<= 2', '2 - 5', '4 - 5', '1 - 2', '<= 2')
segments <- tibble(Segment = segment, Description = description, 
                   R = recency, `F` = frequency, M = monetary)
segments %>%
  kable() %>%
  kable_styling(full_width = TRUE, font_size = 12)
```

## Segmented Customer Data

```{r criteria, echo=FALSE}
rfm_segments <- rfm_result %>%
  use_series(rfm) %>%
  mutate(
    segment = case_when(
      (recency_score %>% between(4, 5)) & (frequency_score %>% between(4, 5)) & 
      (monetary_score %>% between(4, 5))  ~ 'Champions',                       
      (recency_score %>% between(2, 5)) & (frequency_score %>% between(3, 5)) &
      (monetary_score %>% between(3, 5)) ~ 'Loyal Customers',
      (recency_score %>% between(3, 5)) & (frequency_score %>% between(1, 3)) &
      (monetary_score %>% between(1, 3)) ~ 'Potential Loyalist',
      (recency_score %>% between(4, 5)) & (frequency_score == 1) &
      (monetary_score == 1) ~ 'New Customers',
      (recency_score %>% between(3, 4)) & (frequency_score == 1) &
      (monetary_score == 1) ~ 'Promising',
      (recency_score %>% between(2, 3)) & (frequency_score %>% between(2, 3)) &
      (monetary_score %>% between(2, 3)) ~ 'Needs Attention',
      (recency_score %>% between(2, 3)) & (frequency_score <= 2) &
      (monetary_score <= 2) ~ 'About To Sleep',
      (recency_score <= 2) & (frequency_score %>% between(2, 5)) &
      (monetary_score %>% between(2, 5)) ~ 'At Risk',
      (recency_score == 1) & (frequency_score %>% between(4, 5)) &
      (monetary_score %>% between(4, 5)) ~ 'Cant Lose Them',
      (recency_score %>% between(1, 2)) & (frequency_score %>% between(1, 2)) &
      (monetary_score %>% between(1, 2)) ~ 'Hibernating',
      (recency_score <= 2) & (frequency_score  <= 2) &
      (monetary_score  <= 2) ~ 'Lost',
      TRUE ~ 'Others'
    )
  ) %>%
  select(customer_id, segment, rfm_score, transaction_count, recency_days,
         amount) 

# use datatable
rfm_segments %>%
  datatable(filter = 'top', 
            options = list(pageLength = 5, autoWidth = TRUE),
            colnames = c('Customer', 'Segment', 'RFM', 
                         'Orders', 'Recency', 'Total Spend')
  )
```

## Segment Size

```{r rfm_customers}
rfm_segments %>%
  count(segment) %>%
  arrange(desc(n)) %>%
  rename(Segment = segment, Count = n) 
```

## Average Recency

```{r avg_recency, fig.align='center', fig.height=5, fig.width=6}
rfm_segments %>%
  group_by(segment) %>%
  select(segment, recency_days) %>%
  summarize(mean(recency_days)) %>%
  rename(segment = segment, avg_recency = `mean(recency_days)`) %>%
  ggplot(aes(segment, avg_recency)) + 
  geom_bar(stat = 'identity', fill = brewer.pal(n = 8, name = "Set1")) +
  xlab('Segment') + ylab('Average Recency') +
  ggtitle('Average Recency by Segment') +
  coord_flip() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

